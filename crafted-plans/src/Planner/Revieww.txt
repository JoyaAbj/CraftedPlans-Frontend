import React, { useState, useEffect } from 'react';
import axios from 'axios';
import '../Styles/planner.css';

const Review = () => {
  const [plannerData, setPlannerData] = useState({
    coverID: localStorage.getItem('cover'),
    informations: localStorage.getItem('formDataArray'),
    weekStart: localStorage.getItem('selectedStartDay'),
    startDate: localStorage.getItem('selectedPlannerStartDate'),
    endDate: localStorage.getItem('selectedPlannerEndDate'),
    events: JSON.parse(localStorage.getItem('events')),
    pagesID: localStorage.getItem('weeklyPlanner'),
    // addOns: JSON.parse(localStorage.getItem('selectedAddOnTemplates')) || [],
  });

  const [cover, setCover] = useState({ images: [] });
  const [pages, setPages] = useState({ images: [] });
  // const [addOns, setAddOns] = useState([]);

  useEffect(() => {
    const fetchData = async (templateId, setFunction) => {
      try {
        const response = await axios.get(`http://localhost:5000/templates/getTemplateById/${templateId}`);

        if (response.data.templates && response.data.templates.image) {
          const imageUrls = response.data.templates.image;
          setFunction({ images: imageUrls });
        }

        setPlannerData(prevData => ({ ...prevData, template: response.data }));
      } catch (error) {
        console.error('Error fetching template:', error);
      }
    };

    // const fetchAddOns = async () => {
    //   const addOnsArray = plannerData.addOns || [];
    //   const addOnsData = [];

    //   for (const id of addOnsArray) {
    //     try {
    //       const response = await axios.get(`http://localhost:5000/templates/getTemplateById/${id}`);
    //       if (response.data.templates && response.data.templates.image) {
    //         const imageUrls = response.data.templates.image;
    //         // Use only the first image for each add-on
    //         addOnsData.push({ images: [imageUrls[0]] });
    //       }
    //     } catch (error) {
    //       console.error('Error fetching add-on template:', error);
    //     }
    //   }

    //   setAddOns(addOnsData);
    // };

    if (plannerData.coverID) {
      fetchData(plannerData.coverID, setCover);
    }

    if (plannerData.pagesID) {
      fetchData(plannerData.pagesID, setPages);
    }

    // fetchAddOns();
  }, [plannerData.coverID, plannerData.pagesID, 
    // plannerData.addOns
  ]);

  const handleSubmitPlanner = () => {
    axios.post('http://localhost:5000/planners/addPlanner', {
      cover: plannerData.coverID,
      personalInformation: plannerData.informations,
      events: plannerData.events,
      price: 10,
      pages: plannerData.pagesID,
      addOns: plannerData.addOns,
    })
      .then(response => {
        console.log('Success:', response);
      })
      .catch(error => {
        console.error('Error:', error);
      });
  };

  return (
    <div className='Dates'>
      <p className="review-planner">Review Planner Before confirming</p>
      <div>
        <h2>Information:</h2>
        {plannerData.template && (
          <div>
            <p>Cover ID: {plannerData.coverID}</p>
            <p>Information: {plannerData.informations}</p>
          </div>
        )}
        <h2>Cover:</h2>
        {cover.images && cover.images.map((imageUrl, index) => (
          <img
            key={index}
            src={imageUrl}
            alt={`cover-${index}`}
            className="img-cover"
          />
        ))}
        <h2>Dates:</h2>
        <p>Week Start: {plannerData.weekStart}</p>
        <p>Start Date: {plannerData.startDate}</p>
        <p>End Date: {plannerData.endDate}</p>
        <p>Events:</p>
        <ul>
          {plannerData.events.map((event, index) => (
            <li key={index}>{`Event ${index + 1}: ${event.eventName} - ${event.date}`}</li>
          ))}
        </ul>
        <h2>Pages:</h2>
        {pages.images && pages.images.map((imageUrl, index) => (
          <img
            key={index}
            src={imageUrl}
            alt={`pages-${index}`}
            className="img-cover"
          />
        ))}
        {/* <h2>AddOns:</h2>
        {addOns.map((addOn, index) => (
          <div key={index}>
            {addOn.images && addOn.images.map((imageUrl, imgIndex) => (
              <img
                key={imgIndex}
                src={imageUrl}
                alt={`addOn-${index}-${imgIndex}`}
                className="img-cover"
              />
            ))}
          </div>
        ))} */}
      </div>
      <button onClick={handleSubmitPlanner}>Submit Planner</button>
    </div>
  );
};

export default Review;
